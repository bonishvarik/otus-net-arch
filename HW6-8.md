- [EVPN over VXLAN](#evpn-over-vxlan)
  * [Исходные данные](Исходные-данные)
  * [Начальная настройка](начальная-настройка)
  * [Настройка L2-связности между хостами](настройка-l2-связности-между-хостами-)
  * [Настройка ESI Multihoming в режиме All-Active](#----------esi-multihoming----------all-active)
  * [Настройка маршрутизации между VNI для Client-A и Client-B](#------------------------------vni-----client-a---client-b)
  * [Настройка MultiPOD](#----------multipod)

<small><i><a href='http://ecotrust-canada.github.io/markdown-toc/'>Table of contents generated with markdown-toc</a></i></small>


# EVPN over VXLAN
## Исходные данные
Топология сети выглядит следующим образом
![Топология сети](https://github.com/bonishvarik/otus-net-arch/raw/main/HW6-8_topo.PNG)


Распределение Loopback-адресов:
| Адрес | Устройство | Интерфейс |
| ------ | ------ | ------ |
| 10.255.0.1/32 | Spine1 | Loopback 0.0 |
| 10.255.0.2/32 | Spine2 | Loopback 0.0 |
| 10.255.0.11/32 | Leaf1 | Loopback 0.0 |
| 10.255.0.22/32 | Leaf2 | Loopback 0.0 |
| 10.255.0.33/32 | Leaf3 | Loopback 0.0 |



Адресация клиентских машин:
| Host | Host Address | DC Node | DC Iface |
| ------ | ------ | ------ | ------ |
| Client-A-1 | 192.168.1.101/24 | J-Leaf-1 | xe-0/0/0 | 
| Client-A-2 | 192.168.1.102/24 | J-Leaf-2 | xe-0/0/1 |
| Client-A-2 | 192.168.1.102/24 | J-Leaf-2 | xe-0/0/1 |
| Client-A-3 | 192.168.1.103/24 | J-Leaf-3 | xe-0/0/1 |
| Client-B-1 | 192.168.2.101/24 | J-Leaf-1 | xe-0/0/2 |
| Client-B-2 | 192.168.2.102/24 | J-Leaf-2 | xe-0/0/1 |
| Client-B-3 | 192.168.2.103/24 | J-Leaf-2 | xe-0/0/1 |

## Начальная настройка

В качестве протокола UNDERLAY-сети будем использовать OSPF с целью обмена Loopback-аресами. На физических интерфейсах будем использовать функционал unnumbered-address, что позволит заимствовать IP с логического интерфейса Lo0. Это сильно упростит настройку и повысит возможности для масштабирования. 

Типовая настройка роутеров для UNDERLAY будет выглядеть следующим образом: 
```
interfaces {
    xe-0/0/8 {
        unit 0 {
            family inet {
                unnumbered-address lo0.0;
            }
        }
    }
    xe-0/0/9 {
        unit 0 {
            family inet {
                unnumbered-address lo0.0;
            }
        }                               
    }
    lo0 {
        unit 0 {
            family inet {
                address 10.255.0.11/32;
            }
        }
    }
}
protocols {
    ospf {
        area 0.0.0.0 {                  
            interface lo0.0 {
                passive;
            }
            interface xe-0/0/8.0 {
                interface-type p2p;
                authentication {
                    md5 1 key "$9$5Q6AIEyMWxhSYoJUmPO1IhlK8X7"; ## SECRET-DATA
                }
            }
            interface xe-0/0/9.0 {
                interface-type p2p;
                authentication {
                    md5 1 key "$9$-ZV2aHqf3nC.PIcyex7DiH.Tz69A"; ## SECRET-DATA
                }
            }
        }
    }
}
```
В целом, все просто:
+ настраиваем IP на Loopback-интерфейсе
+ для физических интерфейсов в сторону соседних железок настраиваем unnumbered-address
+ настраиваем OSPF в area 0 по следующим правилам:
  - lo0.0 - пассивный
  - интерфейсы в сторону соседей указываем как p2p
  - настраиваем аутентификацию для OSPF, что обезопасит от непредвиденного установления соседства (пароль qwerty123)

<details>
  <summary>Вот так выглядят вышеуказанные строки в виде команд для конфига</summary>

```
  set interfaces lo0 unit 0 family inet address 10.255.0.11/32
  set interfaces xe-0/0/8 unit 0 family inet unnumbered-address lo0.0
  set interfaces xe-0/0/9 unit 0 family inet unnumbered-address lo0.0
  set protocols ospf area 0.0.0.0 interface lo0.0 passive
  set protocols ospf area 0.0.0.0 interface xe-0/0/8.0 interface-type p2p
  set protocols ospf area 0.0.0.0 interface xe-0/0/8.0 authentication md5 1 key qwerty123
  set protocols ospf area 0.0.0.0 interface xe-0/0/9.0 interface-type p2p
  set protocols ospf area 0.0.0.0 interface xe-0/0/9.0 authentication md5 1 key qwerty123
  ```
</details>

Далее, OVERLAY. Здесь тоже все более-менее просто: каждый Leaf устанавливает iBGP-соседство с каждым Spine с address-family EVPN SIGNALLING. Оба Spine выступают в качестве единого Route-Reflector кластера, то есть, помимо iBGP-сессиями с Leaf необходимо поднять iBGP между SPINE. 
Конфигурация BGP для Spine будет выглядеть следующим образом: 
```
routing-options {
    router-id 10.255.0.1;
    autonomous-system 64512;
}
protocols {
    bgp {
        group LEAF {
            type internal;
            local-address 10.255.0.1;
            family evpn {
                signaling;
            }
            cluster 10.255.0.255;
            multipath;
            neighbor 10.255.0.11;
            neighbor 10.255.0.22;
            neighbor 10.255.0.33;
        }                               
        group RR {
            type internal;
            local-address 10.255.0.1;
            family evpn {
                signaling;
            }
            multipath;
            neighbor 10.255.0.2;
        }
    }
}
```

Конфигурация BGP для LEAF выглядит так:
```
routing-options {
    router-id 10.255.0.11;
    autonomous-system 64512;
}
protocols {
    bgp {
        group SPINE {
            type internal;
            local-address 10.255.0.11;
            family evpn {
                signaling;
            }
            multipath;
            neighbor 10.255.0.1;
            neighbor 10.255.0.2;
        }
    }
}
```

Помимо того, что на всех железках для каждой BGP-группы настраиваем Multipath, дополнительно необходимо создать политику для балансировки трафика по нескольким линкам: 
```
routing-options {
    forwarding-table {
        export load-balance;
    }
}
policy-options {
    policy-statement load-balance {
        then {
            load-balance per-packet;
        }
    }
}    

```
После этого можно считать, что подготовка UNDERLAY и OVERLAY готов к накатыванию дальнейшей конфигурации. Промежуточную конфигурацию для каждого узла выглядит так: 
<details>
  <summary>J-Spine-1</summary>

```
  interfaces {                            
    xe-0/0/1 {
        unit 0 {
            family inet {
                unnumbered-address lo0.0;
            }
        }
    }
    xe-0/0/2 {
        unit 0 {
            family inet {
                unnumbered-address lo0.0;
            }
        }
    }
    xe-0/0/3 {
        unit 0 {
            family inet {
                unnumbered-address lo0.0;
            }
        }
    }
    lo0 {
        unit 0 {
            family inet {
                address 10.255.0.1/32;
            }
        }
    }
}
routing-options {
    router-id 10.255.0.1;
    autonomous-system 64512;
    forwarding-table {
        export load-balance;
    }
}
protocols {
    bgp {
        group LEAF {
            type internal;
            local-address 10.255.0.1;
            family evpn {
                signaling;
            }
            cluster 10.255.0.255;
            multipath;
            neighbor 10.255.0.11;
            neighbor 10.255.0.22;
            neighbor 10.255.0.33;
        }                               
        group RR {
            type internal;
            local-address 10.255.0.1;
            family evpn {
                signaling;
            }
            multipath;
            neighbor 10.255.0.2;
        }
    }
    ospf {
        area 0.0.0.0 {
            interface lo0.0 {
                passive;
            }
            interface xe-0/0/1.0 {
                interface-type p2p;
                authentication {
                    md5 1 key "$9$-ZV2aHqf3nC.PIcyex7DiH.Tz69A"; ## SECRET-DATA
                }
            }
            interface xe-0/0/2.0 {
                interface-type p2p;     
                authentication {
                    md5 1 key "$9$5Q6AIEyMWxhSYoJUmPO1IhlK8X7"; ## SECRET-DATA
                }
            }
            interface xe-0/0/3.0 {
                interface-type p2p;
                authentication {
                    md5 1 key "$9$-ZV2aHqf3nC.PIcyex7DiH.Tz69A"; ## SECRET-DATA
                }
            }
        }
}
policy-options {
    policy-statement load-balance {
        then {
            load-balance per-packet;
        }
    }
}                      
  ```
</details>

<details>
  <summary>J-Spine-2</summary>

```
  interfaces {                            
    xe-0/0/1 {
        unit 0 {
            family inet {
                unnumbered-address lo0.0;
            }
        }
    }
    xe-0/0/2 {
        unit 0 {
            family inet {
                unnumbered-address lo0.0;
            }
        }
    }
    xe-0/0/3 {
        unit 0 {
            family inet {
                unnumbered-address lo0.0;
            }
        }
    }
    lo0 {
        unit 0 {
            family inet {
                address 10.255.0.2/32;
            }
        }
    }
}
routing-options {
    router-id 10.255.0.2;
    autonomous-system 64512;
    forwarding-table {
        export load-balance;
    }
}
protocols {
    bgp {
        group LEAF {
            type internal;
            local-address 10.255.0.2;
            family evpn {
                signaling;
            }
            cluster 10.255.0.255;
            multipath;
            neighbor 10.255.0.11;
            neighbor 10.255.0.22;
            neighbor 10.255.0.33;
        }                               
        group RR {
            type internal;
            local-address 10.255.0.2;
            family evpn {
                signaling;
            }
            multipath;
            neighbor 10.255.0.1;
        }
    }
    ospf {
        area 0.0.0.0 {
            interface lo0.0 {
                passive;
            }
            interface xe-0/0/1.0 {
                interface-type p2p;
                authentication {
                    md5 1 key "$9$-ZV2aHqf3nC.PIcyex7DiH.Tz69A"; ## SECRET-DATA
                }
            }
            interface xe-0/0/2.0 {
                interface-type p2p;     
                authentication {
                    md5 1 key "$9$5Q6AIEyMWxhSYoJUmPO1IhlK8X7"; ## SECRET-DATA
                }
            }
            interface xe-0/0/3.0 {
                interface-type p2p;
                authentication {
                    md5 1 key "$9$-ZV2aHqf3nC.PIcyex7DiH.Tz69A"; ## SECRET-DATA
                }
            }
        }
}
policy-options {
    policy-statement load-balance {
        then {
            load-balance per-packet;
        }
    }
}                      
  ```
</details>

<details>
  <summary>J-Leaf-1</summary>

```
interfaces {
    xe-0/0/8 {
        unit 0 {
            family inet {
                unnumbered-address lo0.0;
            }
        }
    }
    xe-0/0/9 {
        unit 0 {
            family inet {
                unnumbered-address lo0.0;
            }
        }                               
    }
    lo0 {
        unit 0 {
            family inet {
                address 10.255.0.11/32;
            }
        }
    }
}
routing-options {
    router-id 10.255.0.11;
    autonomous-system 64512;
    forwarding-table {
        export load-balance;
    }
}
protocols {
    bgp {
        group SPINE {
            type internal;
            local-address 10.255.0.11;
            family evpn {
                signaling;
            }
            multipath;
            neighbor 10.255.0.1;
            neighbor 10.255.0.2;
        }
    }
    ospf {                              
        area 0.0.0.0 {
            interface lo0.0 {
                passive;
            }
            interface xe-0/0/8.0 {
                interface-type p2p;
                authentication {
                    md5 1 key "$9$5Q6AIEyMWxhSYoJUmPO1IhlK8X7"; ## SECRET-DATA
                }
            }
            interface xe-0/0/9.0 {
                interface-type p2p;
                authentication {
                    md5 1 key "$9$-ZV2aHqf3nC.PIcyex7DiH.Tz69A"; ## SECRET-DATA
                }
            }
        }
    }
}
policy-options {
    policy-statement load-balance {
        then {
            load-balance per-packet;
        }
    }
}                  
```
</details>

<details>
  <summary>J-Leaf-2</summary>

```
interfaces {
    xe-0/0/8 {
        unit 0 {
            family inet {
                unnumbered-address lo0.0;
            }
        }
    }
    xe-0/0/9 {
        unit 0 {
            family inet {
                unnumbered-address lo0.0;
            }
        }                               
    }
    lo0 {
        unit 0 {
            family inet {
                address 10.255.0.22/32;
            }
        }
    }
}
routing-options {
    router-id 10.255.0.22;
    autonomous-system 64512;
    forwarding-table {
        export load-balance;
    }
}
protocols {
    bgp {
        group SPINE {
            type internal;
            local-address 10.255.0.22;
            family evpn {
                signaling;
            }
            multipath;
            neighbor 10.255.0.1;
            neighbor 10.255.0.2;
        }
    }
    ospf {                              
        area 0.0.0.0 {
            interface lo0.0 {
                passive;
            }
            interface xe-0/0/8.0 {
                interface-type p2p;
                authentication {
                    md5 1 key "$9$5Q6AIEyMWxhSYoJUmPO1IhlK8X7"; ## SECRET-DATA
                }
            }
            interface xe-0/0/9.0 {
                interface-type p2p;
                authentication {
                    md5 1 key "$9$-ZV2aHqf3nC.PIcyex7DiH.Tz69A"; ## SECRET-DATA
                }
            }
        }
    }
}
policy-options {
    policy-statement load-balance {
        then {
            load-balance per-packet;
        }
    }
}                  
```
</details>

<details>
  <summary>J-Leaf-3</summary>

```
interfaces {
    xe-0/0/8 {
        unit 0 {
            family inet {
                unnumbered-address lo0.0;
            }
        }
    }
    xe-0/0/9 {
        unit 0 {
            family inet {
                unnumbered-address lo0.0;
            }
        }                               
    }
    lo0 {
        unit 0 {
            family inet {
                address 10.255.0.33/32;
            }
        }
    }
}
routing-options {
    router-id 10.255.0.33;
    autonomous-system 64512;
    forwarding-table {
        export load-balance;
    }
}
protocols {
    bgp {
        group SPINE {
            type internal;
            local-address 10.255.0.33;
            family evpn {
                signaling;
            }
            multipath;
            neighbor 10.255.0.1;
            neighbor 10.255.0.2;
        }
    }
    ospf {                              
        area 0.0.0.0 {
            interface lo0.0 {
                passive;
            }
            interface xe-0/0/8.0 {
                interface-type p2p;
                authentication {
                    md5 1 key "$9$5Q6AIEyMWxhSYoJUmPO1IhlK8X7"; ## SECRET-DATA
                }
            }
            interface xe-0/0/9.0 {
                interface-type p2p;
                authentication {
                    md5 1 key "$9$-ZV2aHqf3nC.PIcyex7DiH.Tz69A"; ## SECRET-DATA
                }
            }
        }
    }
}
policy-options {
    policy-statement load-balance {
        then {
            load-balance per-packet;
        }
    }
}                  
```
</details>

Теперь убедимся, что OSPF и BGP-соседства успешно установились: 
Spine1: 
```
root@J-Spine-1> show ospf neighbor 
Address          Interface              State     ID               Pri  Dead
10.255.0.22      xe-0/0/1.0             Full      10.255.0.22      128    32
10.255.0.11      xe-0/0/2.0             Full      10.255.0.11      128    33
10.255.0.33      xe-0/0/3.0             Full      10.255.0.33      128    39

{master:0}

root@J-Spine-1> show bgp summary 
Groups: 2 Peers: 4 Down peers: 0
Table          Tot Paths  Act Paths Suppressed    History Damp State    Pending
bgp.evpn.0           
                      19         19          0          0          0          0
Peer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...
10.255.0.2            64512        116        117       0       0       43:38 Establ
  bgp.evpn.0: 0/0/0/0
10.255.0.11           64512        107        113       0       0       44:49 Establ
  bgp.evpn.0: 8/8/8/0
10.255.0.22           64512        107        111       0       0       44:45 Establ
  bgp.evpn.0: 7/7/7/0
10.255.0.33           64512        104        114       0       0       44:41 Establ
  bgp.evpn.0: 4/4/4/0

```
Spine2:
```
root@J-Spine-2> show ospf neighbor    
Address          Interface              State     ID               Pri  Dead
10.255.0.22      xe-0/0/1.0             Full      10.255.0.22      128    33
10.255.0.11      xe-0/0/2.0             Full      10.255.0.11      128    35
10.255.0.33      xe-0/0/3.0             Full      10.255.0.33      128    35

{master:0}

root@J-Spine-2> show bgp summary 
Groups: 2 Peers: 4 Down peers: 0
Table          Tot Paths  Act Paths Suppressed    History Damp State    Pending
bgp.evpn.0           
                      19         19          0          0          0          0
Peer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...
10.255.0.1            64512         20         21       0       0          11 Establ
  bgp.evpn.0: 0/0/0/0
10.255.0.11           64512          8         14       0       0          23 Establ
  bgp.evpn.0: 8/8/8/0
10.255.0.22           64512          8         13       0       0          19 Establ
  bgp.evpn.0: 7/7/7/0
10.255.0.33           64512          5         16       0       0          15 Establ
  bgp.evpn.0: 4/4/4/0

```

Отлично, все соседства установлены. Теперь можно переходить к настройки L2-связности между хостами групп Client-A и Client-B. 

## Настройка L2-связности между хостами

| Host | Host Address | DC VLAN | VNI |
| ------ | ------ | ------ | ------ |
| Client-A-1 | 192.168.1.101/24 | 10 | 10010 | 
| Client-A-3 | 192.168.1.103/24 | 10 | 10010 |
| Client-B-1 | 192.168.2.101/24 | 20 | 10020 |
| Client-B-2 | 192.168.2.102/24 | 20 | 10020 |
| Client-B-3 | 192.168.2.103/24 | 20 | 10020 |

Для начала, на всех Leaf создадим VLAN и настроем интерфейсы в сторону клиентов. Для примера возьмем конфигурацию J-Leaf-3, на остальных конфигурация аналогична. 
```
vlans {
    Client-A {                 # VLAN для Client-A
        vlan-id 10;
        vxlan {
            vni 10010;         # его номер VNI
        }
    }
    Client-B {                 # VLAN для Client-B
        vlan-id 20;
        vxlan {
            vni 10020;         # его номер VNI
        }
    }
}
interfaces {
    xe-0/0/1 {                 # интерфейс в сторону Client-A-3
        unit 0 {
            family ethernet-switching {
                interface-mode access;
                vlan {
                    members Client-A;
                }
            }
        }
    }
    xe-0/0/2 {                 # интерфейс в сторону Client-B-3
        unit 0 {
            family ethernet-switching {
                interface-mode access;
                vlan {
                    members Client-B;
                }
            }
        }
    }
}

```

Теперь перейдем к настройке самого EVPN: 
```
protocols {
    evpn {
        encapsulation vxlan;                # указываем тип инкапсуляции
        extended-vni-list all;              # разрешаем все VNI
    }
}
switch-options {
    vtep-source-interface lo0.0;            # адрес, с которого будет строиться VXLAN-туннель
    route-distinguisher 10.255.0.33:1;      # RD для маршрутов EVPN
    vrf-target {
        target:64512:100;                   # RT для Auto-Discovery
        auto;                               # автоматическое назначение RT для VNI, позволяет избежать ручного указания RT для каждого VNI
    }
}
```


<details>
  <summary>Аналогичные настройки для J-Leaf-1</summary>

```
vlans {
    Client-A {
        vlan-id 10;
        vxlan {
            vni 10010;                  
        }
    }
    Client-B {
        vlan-id 20;
        vxlan {
            vni 10020;
        }
    }
}   
interfaces {
    xe-0/0/0 {
        unit 0 {
            family ethernet-switching {
                interface-mode access;
                vlan {
                    members Client-A;
                }
            }
        }
    }
    xe-0/0/1 {
        ether-options {
            802.3ad ae0;
        }
    }                                   
    xe-0/0/2 {
        unit 0 {
            family ethernet-switching {
                interface-mode access;
                vlan {
                    members Client-B;
                }
            }
        }
    }
}
protocols {
    evpn {
        encapsulation vxlan;
        extended-vni-list all;
    }
}
switch-options {
    vtep-source-interface lo0.0;
    route-distinguisher 10.255.0.11:1;
    vrf-target {
        target:64512:100;
        auto;
    }
}
```
</details>

<details>
  <summary>Аналогичные настройки для J-Leaf-2</summary>

```
vlans {
    Client-A {
        vlan-id 10;
        vxlan {
            vni 10010;                  
        }
    }
    Client-B {
        vlan-id 20;
        vxlan {
            vni 10020;
        }
    }
}
interfaces {
    xe-0/0/2 {
        unit 0 {
            family ethernet-switching {
                interface-mode access;
                vlan {
                    members Client-B;
                }
            }
        }
    }                                   
}
protocols {
    evpn {
        encapsulation vxlan;
        extended-vni-list all;
    }
}
switch-options {
    vtep-source-interface lo0.0;
    route-distinguisher 10.255.0.22:1;
    vrf-target {
        target:64512:100;
        auto;
    }
}             
```
</details>

Теперь проверим связность между Client-A-1 и Client-A-3: 
```
Client-A-1> ping 192.168.1.103

84 bytes from 192.168.1.103 icmp_seq=1 ttl=64 time=44.349 ms
84 bytes from 192.168.1.103 icmp_seq=2 ttl=64 time=44.622 ms
84 bytes from 192.168.1.103 icmp_seq=3 ttl=64 time=48.643 ms
84 bytes from 192.168.1.103 icmp_seq=4 ttl=64 time=68.405 ms
84 bytes from 192.168.1.103 icmp_seq=5 ttl=64 time=74.344 ms
```
Связность есть, глянем ARP-таблицу на Client-A-1:
```
Client-A-1> arp

00:50:79:66:68:16  192.168.1.103 expires in 64 seconds 
```
Проверим на J-Leaf-1 наличие маршрута типа 2 с данным MAC-адресом: 
```
root@J-Leaf-1> show route table bgp.evpn.0 match-prefix "2:*00:50:79:66:68:16*"    

bgp.evpn.0: 10 destinations, 20 routes (10 active, 0 holddown, 0 hidden)
+ = Active Route, - = Last Active, * = Both

2:10.255.0.33:1::10010::00:50:79:66:68:16/304               
                   *[BGP/170] 00:49:35, localpref 100, from 10.255.0.1
                      AS path: I, validation-state: unverified
                      to 10.255.0.1 via xe-0/0/8.0
                    > to 10.255.0.2 via xe-0/0/9.0
                    [BGP/170] 00:49:35, localpref 100
                      AS path: I, validation-state: unverified
                      to 10.255.0.1 via xe-0/0/8.0
                    > to 10.255.0.2 via xe-0/0/9.0
```
Как видим, маршрут 2 типа в таблице маршрутизации присутствует, причем он виден от двух соседей и оба соседа стоят в качестве next-hop. 
Route-Distinguisher маршрута 10.255.0.33:1, говорит о том, что данный маршрут прилетел от J-Leaf-3.
Теперь посмотрим все маршруты 2 типа в таблице маршрутизации, но уже на J-Leaf-2:
```
root@J-Leaf-2> show route table bgp.evpn.0 match-prefix "2:*"    

bgp.evpn.0: 11 destinations, 22 routes (11 active, 0 holddown, 0 hidden)
+ = Active Route, - = Last Active, * = Both

2:10.255.0.11:1::10010::00:50:79:66:68:0f/304               
                   *[BGP/170] 00:07:27, localpref 100, from 10.255.0.1
                      AS path: I, validation-state: unverified
                      to 10.255.0.1 via xe-0/0/8.0
                    > to 10.255.0.2 via xe-0/0/9.0
                    [BGP/170] 00:07:27, localpref 100
                      AS path: I, validation-state: unverified
                      to 10.255.0.1 via xe-0/0/8.0
                    > to 10.255.0.2 via xe-0/0/9.0
2:10.255.0.11:1::10020::00:50:79:66:68:17/304               
                   *[BGP/170] 00:07:48, localpref 100, from 10.255.0.1
                      AS path: I, validation-state: unverified
                      to 10.255.0.1 via xe-0/0/8.0
                    > to 10.255.0.2 via xe-0/0/9.0
                    [BGP/170] 00:07:48, localpref 100
                      AS path: I, validation-state: unverified
                      to 10.255.0.1 via xe-0/0/8.0
                    > to 10.255.0.2 via xe-0/0/9.0
2:10.255.0.33:1::10010::00:50:79:66:68:16/304               
                   *[BGP/170] 00:52:14, localpref 100, from 10.255.0.1
                      AS path: I, validation-state: unverified
                      to 10.255.0.1 via xe-0/0/8.0
                    > to 10.255.0.2 via xe-0/0/9.0
                    [BGP/170] 00:52:14, localpref 100
                      AS path: I, validation-state: unverified
                      to 10.255.0.1 via xe-0/0/8.0
                    > to 10.255.0.2 via xe-0/0/9.0
2:10.255.0.33:1::10020::00:50:79:66:68:15/304               
                   *[BGP/170] 00:07:35, localpref 100
                      AS path: I, validation-state: unverified
                    > to 10.255.0.1 via xe-0/0/8.0
                      to 10.255.0.2 via xe-0/0/9.0
                    [BGP/170] 00:07:35, localpref 100, from 10.255.0.2
                      AS path: I, validation-state: unverified
                    > to 10.255.0.1 via xe-0/0/8.0
                      to 10.255.0.2 via xe-0/0/9.0
```
Теперь проверим связность от Client-B-2 до Client-B-1 и Client-B-3: 
```
Client-B-2> ping 192.168.2.101

84 bytes from 192.168.2.101 icmp_seq=1 ttl=64 time=54.134 ms
84 bytes from 192.168.2.101 icmp_seq=2 ttl=64 time=34.348 ms
84 bytes from 192.168.2.101 icmp_seq=3 ttl=64 time=43.666 ms
84 bytes from 192.168.2.101 icmp_seq=4 ttl=64 time=39.452 ms
84 bytes from 192.168.2.101 icmp_seq=5 ttl=64 time=31.208 ms

Client-B-2> ping 192.168.2.103

84 bytes from 192.168.2.103 icmp_seq=1 ttl=64 time=31.547 ms
84 bytes from 192.168.2.103 icmp_seq=2 ttl=64 time=33.964 ms
84 bytes from 192.168.2.103 icmp_seq=3 ttl=64 time=44.730 ms
84 bytes from 192.168.2.103 icmp_seq=4 ttl=64 time=61.545 ms
84 bytes from 192.168.2.103 icmp_seq=5 ttl=64 time=32.660 ms
```
Связность есть, проверим ARP-таблицу:
```
Client-B-2> arp

00:50:79:66:68:17  192.168.2.101 expires in 72 seconds 
00:50:79:66:68:15  192.168.2.103 expires in 79 seconds 
```
И теперь на J-Leaf-2 посмотрим источники данных MAC'ов:
<details>
  <summary>root@J-Leaf-2> show route table bgp.evpn.0 match-prefix "2:*00:50:79:66:68:17*"</summary>

```
bgp.evpn.0: 11 destinations, 22 routes (11 active, 0 holddown, 0 hidden)
+ = Active Route, - = Last Active, * = Both

2:10.255.0.11:1::10020::00:50:79:66:68:17/304               
                   *[BGP/170] 00:11:49, localpref 100, from 10.255.0.1
                      AS path: I, validation-state: unverified
                      to 10.255.0.1 via xe-0/0/8.0
                    > to 10.255.0.2 via xe-0/0/9.0
                    [BGP/170] 00:11:49, localpref 100
                      AS path: I, validation-state: unverified
                      to 10.255.0.1 via xe-0/0/8.0
                    > to 10.255.0.2 via xe-0/0/9.0
```
</details>

<details>
  <summary>root@J-Leaf-2> show route table bgp.evpn.0 match-prefix "2:*00:50:79:66:68:15*"</summary>
    
```
bgp.evpn.0: 11 destinations, 22 routes (11 active, 0 holddown, 0 hidden)
+ = Active Route, - = Last Active, * = Both

2:10.255.0.33:1::10020::00:50:79:66:68:15/304               
                   *[BGP/170] 00:12:14, localpref 100
                      AS path: I, validation-state: unverified
                    > to 10.255.0.1 via xe-0/0/8.0
                      to 10.255.0.2 via xe-0/0/9.0
                    [BGP/170] 00:12:14, localpref 100, from 10.255.0.2
                      AS path: I, validation-state: unverified
                    > to 10.255.0.1 via xe-0/0/8.0
                      to 10.255.0.2 via xe-0/0/9.0
```
</details>
Маршруты прилетели откуда и ожидалось, на данном этапе можно считать настройку L2 связности оконченной. 

## Настройка ESI Multihoming в режиме All-Active
Следующим шагом по настройке будет конфигурирование EVPN ESI Multihoming в режиме All-Active. 
Данный функционал позволит подключить клиентское оборудование к двум разным Leaf, что обеспечивает отказоустойчивость в случае выхода из строя одного из Leaf или линка до него. Двумя линками к нам будет подключаться Client-A-2, конфигурация на нем будет выглядеть следующим образом: 

<details>
  <summary>Конфигурация Client-A-2</summary>
    
```
hostname Client-A-2
!
no ip domain-lookup
!
interface Port-channel1
 switchport trunk allowed vlan 10
 switchport trunk encapsulation dot1q
 switchport mode trunk
!
interface Ethernet0/0
 switchport trunk allowed vlan 10
 switchport trunk encapsulation dot1q
 switchport mode trunk
 channel-group 1 mode active
!
interface Ethernet0/1
 switchport trunk allowed vlan 10
 switchport trunk encapsulation dot1q
 switchport mode trunk
 channel-group 1 mode active
!
interface Vlan10
 ip address 192.168.1.102 255.255.255.0
!
```
</details>
Конфигурацию Juniper рассмотрим со стороны J-Leaf-1. Первым делом включим возможность организовывать LAG:

```
chassis {
    aggregated-devices {
        ethernet {
            device-count 10;
        }
    }
}
```
Далее, настроим LAG на интерфейсе в сторону клиента: 

```
interfaces {
    xe-0/0/1 {
        ether-options {
            802.3ad ae0;           // ae0 - номер LAG на локальном устройстве
        }
    } 
}
```
И теперь, собственно, сконфигурируем сам интерфейс ae0 в LACP-режиме active, дополнительно ограничим частоту отправки LACP-сообщений 30 секундами. Поскольку клиент будет строить LAG с двумя Leaf, необходимо вручную задать system-id для LACP, чтобы оба Leaf определялись клиентом как единое устройство: 

```
set interfaces ae0 aggregated-ether-options lacp active
set interfacea ae0 aggregated-ether-options lacp periodic slow
set interfaces ae0 aggregated-ether-options lacp system-id 02:05:86:71:5d:00
```
Следующим этапом необходимо настроить ESI (Ethernet Segment Identifier) - сущность, которая будет определять Multihoming-подключение к клиенту. Для этого необходимо настроить идентификатор ESI, причем он должен быть одинаковым на всех устройствах, подключенных к одному и тому же клиенту. Дополнительно укажем режим работы all-active, что позволит использовать сразу оба линка для передачи данных: 

```
set interfaces ae0 esi 00:11:11:11:11:11:11:11:11:11
set interfaces ae0 esi all-active
```
Ну, теперь осталось дело за малым - настроить порт в режиме trunk и разрешить 10 VLAN: 

```
set interfaces ae0 unit 0 family ethernet-switching interface-mode trunk
set interfaces ae0 unit 0 family ethernet-switching vlan members Client-B
```
<details>
  <summary>Итоговый вариант конфига для LAG на J-Leaf-1</summary>
    
```
chassis {
    aggregated-devices {
        ethernet {
            device-count 2;
        }
    }
}
interfaces {
    xe-0/0/1 {
        ether-options {
            802.3ad ae0;
        }
    }                                   
    ae0 {
        esi {
            00:11:11:11:11:11:11:11:11:11;
            all-active;
        }
        aggregated-ether-options {
            lacp {
                active;
                periodic slow;
                system-id 02:05:86:71:5d:00;
            }
        }
        unit 0 {
            family ethernet-switching {
                interface-mode trunk;
                vlan {
                    members Client-B;
                }
            }
        }
    }
}
```
</details>

<details>
  <summary>Итоговый вариант конфига для LAG на J-Leaf-2</summary>
    
```
chassis {
    aggregated-devices {
        ethernet {
            device-count 2;
        }
    }
}
interfaces {
    xe-0/0/1 {
        ether-options {
            802.3ad ae0;
        }
    }                                   
    ae0 {
        esi {
            00:11:11:11:11:11:11:11:11:11;
            all-active;
        }
        aggregated-ether-options {
            lacp {
                active;
                periodic slow;
                system-id 02:05:86:71:5d:00;
            }
        }
        unit 0 {
            family ethernet-switching {
                interface-mode trunk;
                vlan {
                    members Client-B;
                }
            }
        }
    }
}
```
</details>
Проверим, что на Client-A-2 LAG успешно собрался: 

```
Client-A-2#show lacp 1 neighbor 
Flags:  S - Device is requesting Slow LACPDUs 
        F - Device is requesting Fast LACPDUs
        A - Device is in Active mode       P - Device is in Passive mode     

Channel group 1 neighbors

Partner's information:

                  LACP port                        Admin  Oper   Port    Port
Port      Flags   Priority  Dev ID          Age    key    Key    Number  State
Et0/0     FA      127       0205.8671.5d00   5s    0x0    0x1    0x1     0x3F  
Et0/1     FA      127       0205.8671.5d00  24s    0x0    0x1    0x1     0x3F  

Client-A-2#show lacp 1 internal 
Flags:  S - Device is requesting Slow LACPDUs 
        F - Device is requesting Fast LACPDUs
        A - Device is in Active mode       P - Device is in Passive mode     

Channel group 1
                            LACP port     Admin     Oper    Port        Port
Port      Flags   State     Priority      Key       Key     Number      State
Et0/0     SA      bndl      32768         0x1       0x1     0x1         0x3D  
Et0/1     SA      bndl      32768         0x1       0x1     0x2         0x3D  
```
LAG собран, проверим, как это выглядит на Leaf: 
<details>
  <summary>J-Leaf-1</summary>
    
```
root@J-Leaf-1> show lacp interfaces ae0 
Aggregated interface: ae0
    LACP state:       Role   Exp   Def  Dist  Col  Syn  Aggr  Timeout  Activity
      xe-0/0/1       Actor    No    No   Yes  Yes  Yes   Yes     Slow    Active
      xe-0/0/1     Partner    No    No   Yes  Yes  Yes   Yes     Slow    Active
    LACP protocol:        Receive State  Transmit State          Mux State 
      xe-0/0/1                  Current   Slow periodic Collecting distributing
```
</details>
<details>
  <summary>J-Leaf-2</summary>
    
```
root@J-Leaf-2> show lacp interfaces ae0 
Aggregated interface: ae0
    LACP state:       Role   Exp   Def  Dist  Col  Syn  Aggr  Timeout  Activity
      xe-0/0/1       Actor    No    No   Yes  Yes  Yes   Yes     Slow    Active
      xe-0/0/1     Partner    No    No   Yes  Yes  Yes   Yes     Slow    Active
    LACP protocol:        Receive State  Transmit State          Mux State 
      xe-0/0/1                  Current   Slow periodic Collecting distributing
```
</details>

С этой стороны тоже все работает. Проверим на J-Leaf-3 наличие маршрутов 1 и 4 типа. Маршрут 1 типа покажет режим работы ESI (All-active или single-active), марщрут 4 типа позволяет определить Designated Forwarder для ESI. 
<details>
  <summary>root@J-Leaf-3> show route table bgp.evpn.0 match-prefix "1:*" </summary>
    
```
bgp.evpn.0: 11 destinations, 22 routes (11 active, 0 holddown, 0 hidden)
+ = Active Route, - = Last Active, * = Both

1:10.255.0.11:0::111111111111111111::FFFF:FFFF/304               
                   *[BGP/170] 00:16:29, localpref 100
                      AS path: I, validation-state: unverified
                    > to 10.255.0.1 via xe-0/0/8.0
                      to 10.255.0.2 via xe-0/0/9.0
                    [BGP/170] 00:16:29, localpref 100, from 10.255.0.2
                      AS path: I, validation-state: unverified
                    > to 10.255.0.1 via xe-0/0/8.0
                      to 10.255.0.2 via xe-0/0/9.0
1:10.255.0.11:1::111111111111111111::0/304               
                   *[BGP/170] 00:16:29, localpref 100
                      AS path: I, validation-state: unverified
                    > to 10.255.0.1 via xe-0/0/8.0
                      to 10.255.0.2 via xe-0/0/9.0
                    [BGP/170] 00:16:29, localpref 100, from 10.255.0.2
                      AS path: I, validation-state: unverified
                    > to 10.255.0.1 via xe-0/0/8.0
                      to 10.255.0.2 via xe-0/0/9.0
1:10.255.0.22:0::111111111111111111::FFFF:FFFF/304               
                   *[BGP/170] 02:30:56, localpref 100, from 10.255.0.1
                      AS path: I, validation-state: unverified
                      to 10.255.0.1 via xe-0/0/8.0
                    > to 10.255.0.2 via xe-0/0/9.0
                    [BGP/170] 02:29:54, localpref 100
                      AS path: I, validation-state: unverified
                      to 10.255.0.1 via xe-0/0/8.0
                    > to 10.255.0.2 via xe-0/0/9.0
1:10.255.0.22:1::111111111111111111::0/304               
                   *[BGP/170] 02:30:56, localpref 100, from 10.255.0.1
                      AS path: I, validation-state: unverified
                      to 10.255.0.1 via xe-0/0/8.0
                    > to 10.255.0.2 via xe-0/0/9.0
                    [BGP/170] 02:29:54, localpref 100
                      AS path: I, validation-state: unverified
                      to 10.255.0.1 via xe-0/0/8.0
                    > to 10.255.0.2 via xe-0/0/9.0
```
</details>
Маршруты есть от обоих Leaf, причем здесь же видно идентификатор ESI. Но режим работы так и не стал понятен. Заглянем более детально в 1 маршрут: 
<details>
  <summary>root@J-Leaf-3> show route table bgp.evpn.0 match-prefix "1:10.255.0.11:0::111111111111111111::FFFF:FFFF/304" extensive active-path </summary>
    
```
bgp.evpn.0: 11 destinations, 22 routes (11 active, 0 holddown, 0 hidden)
1:10.255.0.11:0::111111111111111111::FFFF:FFFF/304 (2 entries, 0 announced)
        *BGP    Preference: 170/-101
                Route Distinguisher: 10.255.0.11:0
                Next hop type: Indirect, Next hop index: 0
                Address: 0x9db5cb0
                Next-hop reference count: 24
                Source: 10.255.0.1
                Protocol next hop: 10.255.0.11
                Indirect next hop: 0x2 no-forward INH Session ID: 0x0
                State: <Active Int Ext>
                Local AS: 64512 Peer AS: 64512
                Age: 20:28      Metric2: 2 
                Validation State: unverified 
                Task: BGP_64512.10.255.0.1
                AS path: I (Originator)
                Cluster list:  10.255.0.255
                Originator ID: 10.255.0.11
                Communities: target:64512:100 encapsulation0:0:0:0:vxlan esi-label:all-active (label 0)
                Import Accepted
                Route Label: 1
                Localpref: 100          
                Router ID: 10.255.0.1
                Secondary Tables: default-switch.evpn.0
                Indirect next hops: 1
                        Protocol next hop: 10.255.0.11 Metric: 2
                        Indirect next hop: 0x2 no-forward INH Session ID: 0x0
                        Indirect path forwarding next hops: 2
                                Next hop type: Router
                                Next hop: 10.255.0.1 via xe-0/0/8.0
                                Session Id: 0x0
                                Next hop: 10.255.0.2 via xe-0/0/9.0
                                Session Id: 0x0
                        10.255.0.11/32 Originating RIB: inet.0
                          Metric: 2                       Node path count: 1
                          Forwarding nexthops: 2
                                Nexthop: 10.255.0.1 via xe-0/0/8.0          

```
</details>
Стоит более детально обратить внимание на строку с Communities:

```
**Communities: target:64512:100 encapsulation0:0:0:0:vxlan esi-label:all-active (label 0)**
```
Вот как раз отсюда виден режим работы Multihoming - all-active. 

Проверим наличие маршрутов 4 типа на J-Leaf-3: 
<details>
  <summary>root@J-Leaf-3> show route table bgp.evpn.0 match-prefix "4:*"</summary>
    
```
bgp.evpn.0: 11 destinations, 22 routes (11 active, 0 holddown, 0 hidden)
```
</details>
Иииии, ничего нет... А все потому, что выборы DR проходят между роутерами, находящимся в данном ESI. В нашем случае это J-Leaf-1 и J-Leaf-2. Повторим процедуру на данных роутерах: 
<details>
  <summary>root@J-Leaf-1> show route table bgp.evpn.0 match-prefix "4:*"</summary>
    
```
bgp.evpn.0: 10 destinations, 20 routes (10 active, 0 holddown, 0 hidden)
+ = Active Route, - = Last Active, * = Both

4:10.255.0.22:0::111111111111111111:10.255.0.22/304               
                   *[BGP/170] 02:40:17, localpref 100
                      AS path: I, validation-state: unverified
                    > to 10.255.0.1 via xe-0/0/8.0
                      to 10.255.0.2 via xe-0/0/9.0
                    [BGP/170] 02:39:17, localpref 100, from 10.255.0.2
                      AS path: I, validation-state: unverified
                    > to 10.255.0.1 via xe-0/0/8.0
                      to 10.255.0.2 via xe-0/0/9.0
```
</details>
Бинго! А теперь другой: 
<details>
  <summary>root@J-Leaf-2> show route table bgp.evpn.0 match-prefix "4:*"</summary>
    
```
bgp.evpn.0: 11 destinations, 22 routes (11 active, 0 holddown, 0 hidden)
+ = Active Route, - = Last Active, * = Both

4:10.255.0.11:0::111111111111111111:10.255.0.11/304               
                   *[BGP/170] 00:23:59, localpref 100
                      AS path: I, validation-state: unverified
                    > to 10.255.0.1 via xe-0/0/8.0
                      to 10.255.0.2 via xe-0/0/9.0
                    [BGP/170] 00:24:00, localpref 100, from 10.255.0.2
                      AS path: I, validation-state: unverified
                    > to 10.255.0.1 via xe-0/0/8.0
                      to 10.255.0.2 via xe-0/0/9.0

```
</details>
И здесь маршрут на месте. Зяглянем более детально: 
<details>
  <summary>root@J-Leaf-2> show route table bgp.evpn.0 match-prefix "4:*" extensive active-path </summary>
    
```
bgp.evpn.0: 11 destinations, 22 routes (11 active, 0 holddown, 0 hidden)
4:10.255.0.11:0::111111111111111111:10.255.0.11/304 (2 entries, 0 announced)
        *BGP    Preference: 170/-101
                Route Distinguisher: 10.255.0.11:0
                Next hop type: Indirect, Next hop index: 0
                Address: 0x9db5c50
                Next-hop reference count: 28
                Source: 10.255.0.1
                Protocol next hop: 10.255.0.11
                Indirect next hop: 0x2 no-forward INH Session ID: 0x0
                State: <Active Int Ext>
                Local AS: 64512 Peer AS: 64512
                Age: 27:26      Metric2: 2 
                Validation State: unverified 
                Task: BGP_64512.10.255.0.1
                AS path: I (Originator)
                Cluster list:  10.255.0.255
                Originator ID: 10.255.0.11
                Communities: encapsulation0:0:0:0:vxlan es-import-target:11-11-11-11-11-11
                Import Accepted
                Localpref: 100
                Router ID: 10.255.0.1   
                Secondary Tables: __default_evpn__.evpn.0
                Indirect next hops: 1
                        Protocol next hop: 10.255.0.11 Metric: 2
                        Indirect next hop: 0x2 no-forward INH Session ID: 0x0
                        Indirect path forwarding next hops: 2
                                Next hop type: Router
                                Next hop: 10.255.0.1 via xe-0/0/8.0
                                Session Id: 0x0
                                Next hop: 10.255.0.2 via xe-0/0/9.0
                                Session Id: 0x0
                        10.255.0.11/32 Originating RIB: inet.0
                          Metric: 2                       Node path count: 1
                          Forwarding nexthops: 2
                                Nexthop: 10.255.0.1 via xe-0/0/8.0
```
</details>
И снова обратим внимание на Communities, здесь у нас и живет на RT для ESI:

```
**Communities: encapsulation0:0:0:0:vxlan es-import-target:11-11-11-11-11-11**
```
Определим, кто же в данном случае является DR для нашего ESI: 
<details>
  <summary>root@J-Leaf-1> show evpn instance designated-forwarder</summary>
    
```
Instance: default-switch
  Number of ethernet segments: 1
    ESI: 00:11:11:11:11:11:11:11:11:11
      Designated forwarder: 10.255.0.11
```
</details>
Убедимся, что его сосед считает точно также: 
<details>
  <summary>root@J-Leaf-2> show evpn instance designated-forwarder</summary>
    
```
Instance: default-switch
  Number of ethernet segments: 1
    ESI: 00:11:11:11:11:11:11:11:11:11
      Designated forwarder: 10.255.0.11
```
</details>
Отлично, они смогли договориться. А теперь проверим связность от Client-A-2 до Client-A-1 и Client-A-3: 

```
Client-A-2#ping 192.168.1.101
Type escape sequence to abort.
Sending 5, 100-byte ICMP Echos to 192.168.1.101, timeout is 2 seconds:
!!!!!
Success rate is 100 percent (5/5), round-trip min/avg/max = 39/59/91 ms
Client-A-2#ping 192.168.1.103
Type escape sequence to abort.
Sending 5, 100-byte ICMP Echos to 192.168.1.103, timeout is 2 seconds:
!!!!!
Success rate is 100 percent (5/5), round-trip min/avg/max = 44/54/71 ms
```
Связность есть, глянем ARP-таблицу и посмотрим маршруты длы данных MAC:
<details>
  <summary>192.168.1.101</summary>
ARP-таблица:

```
Client-A-2#show arp 192.168.1.101
Protocol  Address          Age (min)  Hardware Addr   Type   Interface
Internet  192.168.1.101         106   0050.7966.680f  ARPA   Vlan10
```
Маршрут на J-Leaf-2

```
root@J-Leaf-2> show route table bgp.evpn.0 match-prefix "2:*00:50:79:66:68:0f*"                   

bgp.evpn.0: 11 destinations, 22 routes (11 active, 0 holddown, 0 hidden)
+ = Active Route, - = Last Active, * = Both

2:10.255.0.11:1::10010::00:50:79:66:68:0f/304               
                   *[BGP/170] 01:02:45, localpref 100, from 10.255.0.1
                      AS path: I, validation-state: unverified
                      to 10.255.0.1 via xe-0/0/8.0
                    > to 10.255.0.2 via xe-0/0/9.0
                    [BGP/170] 01:02:45, localpref 100
                      AS path: I, validation-state: unverified
                      to 10.255.0.1 via xe-0/0/8.0
                    > to 10.255.0.2 via xe-0/0/9.0
```
</details>
<details>
  <summary>192.168.1.103</summary>
ARP-таблица:

```
Client-A-2#show arp 192.168.1.103
Protocol  Address          Age (min)  Hardware Addr   Type   Interface
Internet  192.168.1.103         108   0050.7966.6816  ARPA   Vlan10
```
Маршрут на J-Leaf-2:

```
root@J-Leaf-2> show route table bgp.evpn.0 match-prefix "2:*00:50:79:66:68:16*"                   

bgp.evpn.0: 11 destinations, 22 routes (11 active, 0 holddown, 0 hidden)
+ = Active Route, - = Last Active, * = Both

2:10.255.0.33:1::10010::00:50:79:66:68:16/304               
                   *[BGP/170] 01:49:53, localpref 100, from 10.255.0.1
                      AS path: I, validation-state: unverified
                      to 10.255.0.1 via xe-0/0/8.0
                    > to 10.255.0.2 via xe-0/0/9.0
                    [BGP/170] 01:49:53, localpref 100
                      AS path: I, validation-state: unverified
                      to 10.255.0.1 via xe-0/0/8.0
                    > to 10.255.0.2 via xe-0/0/9.0
```
</details>
Маршруты присутствуют. А как выглядит маршрут с MAC-адресом Client-A-2 на J-Leaf-1? Отфильтруем вывод по MAC-адресу. Но для начала нужно узнать этот MAC: 

```
Client-A-2#show arp 192.168.1.102
Protocol  Address          Age (min)  Hardware Addr   Type   Interface
Internet  192.168.1.102           -   aabb.cc80.0d00  ARPA   Vlan10
```
А теперь проверим маршрут: 

```
root@J-Leaf-1> show route table bgp.evpn.0 match-prefix "*aa:bb:cc:80:0d:00*"                     

bgp.evpn.0: 11 destinations, 22 routes (11 active, 0 holddown, 0 hidden)
+ = Active Route, - = Last Active, * = Both

2:10.255.0.22:1::10010::aa:bb:cc:80:0d:00/304               
                   *[BGP/170] 00:05:40, localpref 100, from 10.255.0.1
                      AS path: I, validation-state: unverified
                      to 10.255.0.1 via xe-0/0/8.0
                    > to 10.255.0.2 via xe-0/0/9.0
                    [BGP/170] 00:05:40, localpref 100
                      AS path: I, validation-state: unverified
                      to 10.255.0.1 via xe-0/0/8.0
                    > to 10.255.0.2 via xe-0/0/9.0
```
Шикарно, это все тот же маршрут второго типа, поскольку именно он используется для распространения информации о MAC-адресах. На данном этапе настройку ESI можно считать завершенной. 

## Настройка маршрутизации между VNI для Client-A и Client-B
Для того, чтобы организовать IP-связность между разными VNI, создадим виртуальные L3-интерфейсы irb.10 и irb.20 для каждого из вланов 10 и 20, соответственно. Конфигурацию будем проводить на Spine, с целью создания централизованного роутинга между VNI. Рассмотрим более детально конфиг на примере J-Spine-1.  
Начнем с создания VLAN'ов и L3-интерфейсов: 
```
interfaces {                            
    irb {                                                       # виртуальный интерфейс для роутинга
        unit 10 {                                               # VLAN 10
            proxy-macip-advertisement;                          # включаем анонс в виде Type-2 MAC+IP
            family inet {
                address 192.168.1.1/24;
            }
            mac aa:aa:aa:aa:aa:aa;                              # указываем MAC-адрес для L3-интерфейса
        }                               
        unit 20 {                                               # VLAN 10
            proxy-macip-advertisement;                          # включаем анонс в виде Type-2 MAC+IP
            family inet {
                address 192.168.2.254/24;
            }
            mac aa:aa:aa:aa:aa:aa;                              # указываем MAC-адрес для L3-интерфейса
        }
    }                                
}
vlans {
    Client-A {
        vlan-id 10;
        l3-interface irb.10;                                    # привязываем созданный L3-интерфейс к VLAN 10
        vxlan {
            vni 10010;
        }
    }
    Client-B {
        vlan-id 20;
        l3-interface irb.20;                                    # привязываем созданный L3-интерфейс к VLAN 20
        vxlan {
            vni 10020;
        }
    }
}   
```
Теперь настроим сам EVPN: 
```
switch-options {
    vtep-source-interface lo0.0;
    route-distinguisher 10.255.0.1:1;
    vrf-target {
        target:64512:100;
        auto;
    }
}
protocols {
    evpn {
        encapsulation vxlan;
        extended-vni-list all;
        default-gateway no-gateway-community;
}
```
Заключительным этапом необходимо создать VRF, к котором будет проводиться маршрутизация наших VNI:
```
interfaces {                            
    lo0 {                                   # Loopback-интерфейс для нового VRF
        unit 1 {
            family inet {
                address 10.255.0.255/32;
            }
        }
    }
}
routing-instances {
    VNI_ROUTING {
        instance-type vrf;                   # указываем тип инстанса
        interface irb.10;                    # привязываем L3-интерфейс для VLAN 10
        interface irb.20;                    # привязываем L3-интерфейс для VLAN 20
        interface lo0.1;                     # привязываем Lo0.1, без него не взлетит
        route-distinguisher 10.255.0.1:1020; # указываем RD
        vrf-target target:62773:1020;        # и RT
    }
}
```
На этом все, аналогичная настройка производится на соседнем узле:
<details>
  <summary>Конфигурация J-Spine-2</summary>

```
interfaces {                            
    irb {
        unit 10 {
            proxy-macip-advertisement;
            family inet {
                address 192.168.1.1/24;
            }
            mac aa:aa:aa:aa:aa:aa;
        }
        unit 20 {
            proxy-macip-advertisement;
            family inet {               
                address 192.168.2.1/24;
            }
            mac aa:aa:aa:aa:aa:aa;
        }
    }
    lo0 {
        unit 1 {
            family inet {
                address 10.255.0.255/32;
            }
        }
    }
}
vlans {
    Client-A {                          
        vlan-id 10;
        l3-interface irb.10;
        vxlan {
            vni 10010;
        }
    }
    Client-B {
        vlan-id 20;
        l3-interface irb.20;
        vxlan {
            vni 10020;
        }
    }
    default {
        vlan-id 1;
    }
}
protocols {
    evpn {
        encapsulation vxlan;
        extended-vni-list all;
        default-gateway no-gateway-community;
    }
}
routing-instances {
    VNI_ROUTING {
        instance-type vrf;
        interface irb.10;
        interface irb.20;
        interface lo0.1;
        route-distinguisher 10.255.0.2:1020;
        vrf-target target:62773:1020;
    }
}
switch-options {
    vtep-source-interface lo0.0;
    route-distinguisher 10.255.0.2:1;
    vrf-target {
        target:64512:100;
        auto;
    }
}
```
</details>

Теперь зайдем на Client-A-1 и попробуем пропинговать Client-B-2. Сразу же на J-Leaf-1 проверим EVPN-маршруты:
<details>
  <summary>Проверка Client-B-2</summary>

Проверка прохождения ICMP:
```
Client-A-1> ping 192.168.2.102

84 bytes from 192.168.2.102 icmp_seq=1 ttl=63 time=86.780 ms
84 bytes from 192.168.2.102 icmp_seq=2 ttl=63 time=66.659 ms
84 bytes from 192.168.2.102 icmp_seq=3 ttl=63 time=54.360 ms
84 bytes from 192.168.2.102 icmp_seq=4 ttl=63 time=53.925 ms
84 bytes from 192.168.2.102 icmp_seq=5 ttl=63 time=42.632 ms
```
Проверка маршрута на J-Leaf-1:

```
root@J-Leaf-1> show route table bgp.evpn.0 match-prefix "*192.168.2.102*"     

bgp.evpn.0: 27 destinations, 54 routes (25 active, 0 holddown, 4 hidden)
+ = Active Route, - = Last Active, * = Both

2:10.255.0.22:1::10020::00:50:79:66:68:18::192.168.2.102/304               
                   *[BGP/170] 00:11:35, localpref 100, from 10.255.0.2
                      AS path: I, validation-state: unverified
                    > to 10.255.0.1 via xe-0/0/8.0
                      to 10.255.0.2 via xe-0/0/9.0
                    [BGP/170] 00:11:35, localpref 100
                      AS path: I, validation-state: unverified
                    > to 10.255.0.1 via xe-0/0/8.0
                      to 10.255.0.2 via xe-0/0/9.0
```
Отлично, в EVPN-базе присутствует связка MAC-IP для данного маршрута. Пруф: 

```
root@J-Leaf-1> show evpn database mac-address 00:50:79:66:68:18    
Instance: default-switch
VLAN  VNI  MAC address        Active source                  Timestamp        IP address
      10020 00:50:79:66:68:18  10.255.0.22                    Mar 27 15:17:11  192.168.2.102
```
</details>

А теперь с Client-B-3 проверим связность с Client-A-1:
<details>
  <summary>Проверка Client-A-1</summary>

Проверка прохождения ICMP:
```
Client-B-3> ping 192.168.1.101

84 bytes from 192.168.1.101 icmp_seq=1 ttl=63 time=87.427 ms
84 bytes from 192.168.1.101 icmp_seq=2 ttl=63 time=38.636 ms
84 bytes from 192.168.1.101 icmp_seq=3 ttl=63 time=69.162 ms
84 bytes from 192.168.1.101 icmp_seq=4 ttl=63 time=49.021 ms
84 bytes from 192.168.1.101 icmp_seq=5 ttl=63 time=65.257 ms
```
Проверка маршрута на J-Leaf-3:

```
root@J-Leaf-3> show route table bgp.evpn.0 match-prefix "*192.168.1.101*" 

bgp.evpn.0: 28 destinations, 56 routes (26 active, 0 holddown, 4 hidden)
+ = Active Route, - = Last Active, * = Both

2:10.255.0.11:1::10010::00:50:79:66:68:0f::192.168.1.101/304               
                   *[BGP/170] 00:17:37, localpref 100, from 10.255.0.2
                      AS path: I, validation-state: unverified
                    > to 10.255.0.1 via xe-0/0/8.0
                      to 10.255.0.2 via xe-0/0/9.0
                    [BGP/170] 00:17:37, localpref 100
                      AS path: I, validation-state: unverified
                    > to 10.255.0.1 via xe-0/0/8.0
                      to 10.255.0.2 via xe-0/0/9.0
```
</details>
Как видно, связность между разными VNI есть, цель достигнута. Итоговые конфиги для Spine-узлов: 

<details>
  <summary>J-Spine-1</summary>

```
interfaces {                            
    xe-0/0/1 {
        unit 0 {
            family inet {
                unnumbered-address lo0.0;
            }
        }
    }
    xe-0/0/2 {
        unit 0 {
            family inet {
                unnumbered-address lo0.0;
            }
        }
    }
    xe-0/0/3 {
        unit 0 {
            family inet {
                unnumbered-address lo0.0;
            }
        }
    }
    irb {
        unit 10 {
            proxy-macip-advertisement;
            family inet {
                address 192.168.1.1/24;
            }
            mac aa:aa:aa:aa:aa:aa;
        }
        unit 20 {
            proxy-macip-advertisement;
            family inet {               
                address 192.168.2.1/24;
            }
            mac aa:aa:aa:aa:aa:aa;
        }
    }
    lo0 {
        unit 0 {
            family inet {
                address 10.255.0.1/32;
            }
        }
        unit 1 {
            family inet {
                address 10.255.0.255/32;
            }
        }
    }
}                                 
routing-options {
    router-id 10.255.0.1;
    autonomous-system 64512;
    forwarding-table {
        export load-balance;
    }
}
protocols {
    bgp {
        group LEAF {
            type internal;
            local-address 10.255.0.1;
            family evpn {
                signaling;
            }
            cluster 10.255.0.255;
            multipath;
            neighbor 10.255.0.11;
            neighbor 10.255.0.22;
            neighbor 10.255.0.33;
        }
        group RR {
            type internal;              
            local-address 10.255.0.1;
            family evpn {
                signaling;
            }
            multipath;
            neighbor 10.255.0.2;
        }
    }
    ospf {
        area 0.0.0.0 {
            interface lo0.0 {
                passive;
            }
            interface xe-0/0/1.0 {
                interface-type p2p;
                authentication {
                    md5 1 key "$9$-ZV2aHqf3nC.PIcyex7DiH.Tz69A"; ## SECRET-DATA
                }
            }
            interface xe-0/0/2.0 {
                interface-type p2p;
                authentication {
                    md5 1 key "$9$5Q6AIEyMWxhSYoJUmPO1IhlK8X7"; ## SECRET-DATA
                }
            }
            interface xe-0/0/3.0 {
                interface-type p2p;
                authentication {
                    md5 1 key "$9$-ZV2aHqf3nC.PIcyex7DiH.Tz69A"; ## SECRET-DATA
                }
            }
        }
    }
    evpn {
        encapsulation vxlan;
        extended-vni-list all;
        default-gateway no-gateway-community;
    }
}
policy-options {
    policy-statement load-balance {
        then {
            load-balance per-packet;    
        }
    }
}
routing-instances {
    VNI_ROUTING {
        instance-type vrf;
        interface irb.10;
        interface irb.20;
        interface lo0.1;
        route-distinguisher 10.255.0.1:1020;
        vrf-target target:62773:1020;
    }
}
switch-options {
    vtep-source-interface lo0.0;
    route-distinguisher 10.255.0.1:1;
    vrf-target {
        target:64512:100;
        auto;
    }
}
vlans {
    Client-A {                          
        vlan-id 10;
        l3-interface irb.10;
        vxlan {
            vni 10010;
        }
    }
    Client-B {
        vlan-id 20;
        l3-interface irb.20;
        vxlan {
            vni 10020;
        }
    }
    default {
        vlan-id 1;
    }
}

```
</details>

<details>
  <summary>J-Spine-2</summary>

```
interfaces {                            
    xe-0/0/1 {
        unit 0 {
            family inet {
                unnumbered-address lo0.0;
            }
        }
    }
    xe-0/0/2 {
        unit 0 {
            family inet {
                unnumbered-address lo0.0;
            }
        }
    }
    xe-0/0/3 {
        unit 0 {
            family inet {
                unnumbered-address lo0.0;
            }
        }
    }
    irb {
        unit 10 {
            proxy-macip-advertisement;
            family inet {
                address 192.168.1.1/24;
            }
            mac aa:aa:aa:aa:aa:aa;
        }
        unit 20 {
            proxy-macip-advertisement;
            family inet {               
                address 192.168.2.1/24;
            }
            mac aa:aa:aa:aa:aa:aa;
        }
    }
    lo0 {
        unit 0 {
            family inet {
                address 10.255.0.2/32;
            }
        }
        unit 1 {
            family inet {
                address 10.255.0.255/32;
            }
        }
    }
}                                   
routing-options {
    router-id 10.255.0.2;
    autonomous-system 64512;
    forwarding-table {
        export load-balance;
    }
}
protocols {
    bgp {
        group LEAF {
            type internal;
            local-address 10.255.0.2;
            family evpn {
                signaling;
            }
            cluster 10.255.0.255;
            multipath;
            neighbor 10.255.0.11;
            neighbor 10.255.0.22;
            neighbor 10.255.0.33;
        }
        group RR {
            type internal;              
            local-address 10.255.0.2;
            family evpn {
                signaling;
            }
            multipath;
            neighbor 10.255.0.1;
        }
    }
    ospf {
        area 0.0.0.0 {
            interface lo0.0 {
                passive;
            }
            interface xe-0/0/1.0 {
                interface-type p2p;
                authentication {
                    md5 1 key "$9$-ZV2aHqf3nC.PIcyex7DiH.Tz69A"; ## SECRET-DATA
                }
            }
            interface xe-0/0/2.0 {
                interface-type p2p;
                authentication {
                    md5 1 key "$9$5Q6AIEyMWxhSYoJUmPO1IhlK8X7"; ## SECRET-DATA
                }
            }
            interface xe-0/0/3.0 {
                interface-type p2p;
                authentication {
                    md5 1 key "$9$-ZV2aHqf3nC.PIcyex7DiH.Tz69A"; ## SECRET-DATA
                }
            }
        }
    }
    evpn {
        encapsulation vxlan;
        extended-vni-list all;
        default-gateway no-gateway-community;
    }
}
policy-options {
    policy-statement load-balance {
        then {
            load-balance per-packet;    
        }
    }
}
routing-instances {
    VNI_ROUTING {
        instance-type vrf;
        interface irb.10;
        interface irb.20;
        interface lo0.1;
        route-distinguisher 10.255.0.2:1020;
        vrf-target target:62773:1020;
    }
}
switch-options {
    vtep-source-interface lo0.0;
    route-distinguisher 10.255.0.2:1;
    vrf-target {
        target:64512:100;
        auto;
    }
}
vlans {
    Client-A {                          
        vlan-id 10;
        l3-interface irb.10;
        vxlan {
            vni 10010;
        }
    }
    Client-B {
        vlan-id 20;
        l3-interface irb.20;
        vxlan {
            vni 10020;
        }
    }
}
```
</details>

## Настройка MultiPOD
Изменим чуток схему, добавив туда еще один узел J-Leaf-4 с Loopback-адресом 10.255.0.44, к нему подключим еще одного клиента Client-A-4 с адресом 192.168.1.104:
![Топология сети](https://github.com/bonishvarik/otus-net-arch/raw/main/HW6-8_topo_multipod.PNG)
Данный Leaf будет находиться в общем OSPF-домене, но в другой AS (65000) для OVERLAY BGP. Сконфигурируем Leaf по аналогии с другими устройствами. 
<details>
  <summary>J-Leaf-4</summary>

```
interfaces {
    xe-0/0/0 {
        unit 0 {
            family ethernet-switching {
                interface-mode access;
                vlan {
                    members Client-A;
                }
            }
        }
    }
    xe-0/0/8 {
        unit 0 {
            family inet {
                unnumbered-address lo0.0;
            }
        }
    }
    xe-0/0/9 {
        unit 0 {
            family inet {
                unnumbered-address lo0.0;
            }                           
        }
    }
    lo0 {
        unit 0 {
            family inet {
                address 10.255.0.44/32;
            }
        }
    }
}
routing-options {
    router-id 10.255.0.44;
    autonomous-system 65000;
    forwarding-table {
        export load-balance;
    }
}
protocols {                             
    bgp {
        group SPINE {
            type external;
            multihop;
            local-address 10.255.0.44;
            family evpn {
                signaling;
            }
            peer-as 64512;
            neighbor 10.255.0.1;
            neighbor 10.255.0.2;
        }
    }
    ospf {
        area 0.0.0.0 {
            interface lo0.0 {
                passive;
            }
            interface xe-0/0/8.0 {
                interface-type p2p;
                authentication {
                    md5 1 key "$9$P539BIcKvLRhwgoZq.uOBRylM8X"; ## SECRET-DATA
                }                       
            }
            interface xe-0/0/9.0 {
                interface-type p2p;
                authentication {
                    md5 1 key "$9$IePErvNdsaJDVwfz3/OBX7NV24ZUj"; ## SECRET-DATA
                }
            }
        }
    }
    evpn {
        encapsulation vxlan;
        extended-vni-list all;
        }
    }
}                                       
policy-options {
    policy-statement load-balance {
        then {
            load-balance per-packet;
        }
    }
}
switch-options {
    vtep-source-interface lo0.0;
    route-distinguisher 10.255.0.44:1;
    vrf-target {
        target:65000:100;
        auto;
    }
}
vlans {
    Client-A {
        vlan-id 10;
        vxlan {
            vni 10010;
        }
    }
}
```
</details>

Теперь необходимо настроить BGP на Spine-узлах. Конфигурация будет аналогична для обоих узлов. Приведу для J-Spine-1:

```
protocols {
    bgp {
        group LEAF_AS65000 {
            type external;
            local-address 10.255.0.1;
            family evpn {               
                signaling;
            }
            peer-as 65000;
            neighbor 10.255.0.44;
        }
    }

}
```
Убедимся, что новый Leaf успешно установил соседства и получил все EVPN-префиксы:
<details>
  <summary>root@J-Leaf-4> show bgp summary </summary>

```
Groups: 1 Peers: 2 Down peers: 0
Table          Tot Paths  Act Paths Suppressed    History Damp State    Pending
bgp.evpn.0           
                      66         33          0          0          0          0
Peer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...
10.255.0.1            64512         93         54       0       0       15:49 Establ
  bgp.evpn.0: 23/33/33/0
  default-switch.evpn.0: 0/0/0/0
  __default_evpn__.evpn.0: 0/0/0/0
10.255.0.2            64512        675        635       0       0     4:05:30 Establ
  bgp.evpn.0: 10/33/33/0
  default-switch.evpn.0: 0/0/0/0
  __default_evpn__.evpn.0: 0/0/0/0
```
</details>
Соседство успешно установлено, также видно, что в таблицу bgp.evpn.0 были импортированы маршруты, а вот в локальную базу EVPN default-switch.evpn.0 префиксы не были добавлены. Это связано с тем, что в auto-режиме импортирования и экспортирования политик route-target генерируются на основе номера автономной системы. В данном же случае у нас Leaf и Spine находятся в разных автономных системах. В связи с этим, на всех узлах, где у нас "живет" Client-A нужно будет создать отдельный route-target и политики импорта для данного RT. Пусть это будет RT target:9999:10010. Выглядеть конфиг для RT будет так: 

```
protocols {                             
    evpn {
         vni-options {
            vni 10010 {
                vrf-target export target:9999:10010;
            }
        }
    }
}     
```
Следующим этапом нужно определить политики импорта для EVPN. Поскольку мы будем создавать кастомную политику импорта, она перезапишет дефолтные политики, которая "ловит" маршруты с community для Auto-Discovery. Первым делом определим наши community: 

```
policy-options {
    community local_ad members target:65000:100;        # RT для route type-1 
    community multipod members target:9999:10010;       # RT для vni 10010
}
```

Теперь окончательно напишем политику и применим ее на всех устройствах с VNI 10010: 

```
policy-options {
    policy-statement evpn_import {
        term type-1_import {
            from community local_ad;
            then accept;
        }
        term multipod_import {
            from community multipod;
            then accept;
        }
    }
}
switch-options {
    vtep-source-interface lo0.0;
    route-distinguisher 10.255.0.44:1;
    vrf-import evpn_import;   
    vrf-target {
        target:65000:100;
        auto;
    }
}
```

Посмотрим теперь количество принятых префиксов в таблице default-switch.evpn.0: 

```
root@J-Leaf-4> show bgp summary | match default-switch   
  default-switch.evpn.0: 12/12/12/0
  default-switch.evpn.0: 0/12/12/0
```
Отлично, маршруты появились. Теперь проверим связность от Client-A-4 до клиентов в другом POD: 

<details>
  <summary>Client-A-4> ping 192.168.1.1 (шлюз)</summary>

```
84 bytes from 192.168.1.1 icmp_seq=1 ttl=64 time=167.340 ms
84 bytes from 192.168.1.1 icmp_seq=2 ttl=64 time=56.854 ms
84 bytes from 192.168.1.1 icmp_seq=3 ttl=64 time=32.937 ms
84 bytes from 192.168.1.1 icmp_seq=4 ttl=64 time=39.130 ms
84 bytes from 192.168.1.1 icmp_seq=5 ttl=64 time=37.587 ms
```
</details>

<details>
  <summary>Client-A-4> ping 192.168.2.103 (Client-B-3)</summary>

```
192.168.2.103 icmp_seq=1 timeout
84 bytes from 192.168.2.103 icmp_seq=2 ttl=63 time=47.398 ms
84 bytes from 192.168.2.103 icmp_seq=3 ttl=63 time=117.519 ms
84 bytes from 192.168.2.103 icmp_seq=4 ttl=63 time=43.991 ms
84 bytes from 192.168.2.103 icmp_seq=5 ttl=63 time=51.481 ms
```
</details>

<details>
  <summary>Client-A-4> ping 192.168.1.102 (Client-A-2)</summary>

```
84 bytes from 192.168.1.102 icmp_seq=1 ttl=63 time=121.620 ms
84 bytes from 192.168.1.102 icmp_seq=2 ttl=63 time=59.400 ms
84 bytes from 192.168.1.102 icmp_seq=3 ttl=63 time=58.169 ms
84 bytes from 192.168.1.102 icmp_seq=4 ttl=63 time=95.173 ms
84 bytes from 192.168.1.102 icmp_seq=5 ttl=63 time=78.579 ms
```
</details>

Связность есть, на этом задание можно считать полностью выполненным.
